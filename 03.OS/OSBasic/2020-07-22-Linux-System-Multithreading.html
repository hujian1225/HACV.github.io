<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程同步 | HACV</title>
    <meta name="description" content="Personal Blog Website">
    <link rel="icon" href="/images/photo.jpg">
  <link rel="manifest" href="/images/photo.jpg">
  <link rel="apple-touch-icon" href="/images/photo.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.8eb0d87d.css" as="style"><link rel="preload" href="/assets/js/app.497fe22e.js" as="script"><link rel="preload" href="/assets/js/56.80334add.js" as="script"><link rel="prefetch" href="/assets/js/10.8bbeb718.js"><link rel="prefetch" href="/assets/js/100.c8c3bdc6.js"><link rel="prefetch" href="/assets/js/101.ce709e86.js"><link rel="prefetch" href="/assets/js/102.ce6a96f7.js"><link rel="prefetch" href="/assets/js/103.45c0d5d4.js"><link rel="prefetch" href="/assets/js/104.d9c8a8aa.js"><link rel="prefetch" href="/assets/js/105.babe72af.js"><link rel="prefetch" href="/assets/js/106.3c8bbdca.js"><link rel="prefetch" href="/assets/js/107.379fa1b3.js"><link rel="prefetch" href="/assets/js/108.9e628bbe.js"><link rel="prefetch" href="/assets/js/109.63dee7a8.js"><link rel="prefetch" href="/assets/js/11.390e9c09.js"><link rel="prefetch" href="/assets/js/110.d23fbe19.js"><link rel="prefetch" href="/assets/js/111.49bcd42e.js"><link rel="prefetch" href="/assets/js/112.183c5666.js"><link rel="prefetch" href="/assets/js/113.94007f67.js"><link rel="prefetch" href="/assets/js/114.f003379f.js"><link rel="prefetch" href="/assets/js/115.77f2a310.js"><link rel="prefetch" href="/assets/js/116.5f92f419.js"><link rel="prefetch" href="/assets/js/117.8e672558.js"><link rel="prefetch" href="/assets/js/118.7de461b3.js"><link rel="prefetch" href="/assets/js/119.d27bb626.js"><link rel="prefetch" href="/assets/js/12.47752e11.js"><link rel="prefetch" href="/assets/js/120.555e109f.js"><link rel="prefetch" href="/assets/js/121.2e9db0cc.js"><link rel="prefetch" href="/assets/js/122.590af312.js"><link rel="prefetch" href="/assets/js/123.7b8a9255.js"><link rel="prefetch" href="/assets/js/124.2dafcbcd.js"><link rel="prefetch" href="/assets/js/125.6c5d7b69.js"><link rel="prefetch" href="/assets/js/126.35dd6f5b.js"><link rel="prefetch" href="/assets/js/127.275de61f.js"><link rel="prefetch" href="/assets/js/128.d995dc93.js"><link rel="prefetch" href="/assets/js/129.defed3ff.js"><link rel="prefetch" href="/assets/js/13.9ab56618.js"><link rel="prefetch" href="/assets/js/130.9d05b141.js"><link rel="prefetch" href="/assets/js/131.48d03a37.js"><link rel="prefetch" href="/assets/js/132.d205cdc0.js"><link rel="prefetch" href="/assets/js/133.56a46473.js"><link rel="prefetch" href="/assets/js/134.cc62c37c.js"><link rel="prefetch" href="/assets/js/135.f2411992.js"><link rel="prefetch" href="/assets/js/136.12c83bc0.js"><link rel="prefetch" href="/assets/js/137.d36e1641.js"><link rel="prefetch" href="/assets/js/138.e3505c81.js"><link rel="prefetch" href="/assets/js/139.5dc6900e.js"><link rel="prefetch" href="/assets/js/14.62a5eff5.js"><link rel="prefetch" href="/assets/js/140.4a2e0dec.js"><link rel="prefetch" href="/assets/js/141.08cd0900.js"><link rel="prefetch" href="/assets/js/142.e15348eb.js"><link rel="prefetch" href="/assets/js/143.2b958062.js"><link rel="prefetch" href="/assets/js/144.e3919269.js"><link rel="prefetch" href="/assets/js/145.6acb3cba.js"><link rel="prefetch" href="/assets/js/146.a44bc999.js"><link rel="prefetch" href="/assets/js/147.006c244d.js"><link rel="prefetch" href="/assets/js/148.0ceaf017.js"><link rel="prefetch" href="/assets/js/149.eb7fe757.js"><link rel="prefetch" href="/assets/js/15.7d2d48ae.js"><link rel="prefetch" href="/assets/js/150.6bd6bd49.js"><link rel="prefetch" href="/assets/js/151.5b65f44b.js"><link rel="prefetch" href="/assets/js/152.4e584419.js"><link rel="prefetch" href="/assets/js/16.8786bc8f.js"><link rel="prefetch" href="/assets/js/17.5312e725.js"><link rel="prefetch" href="/assets/js/18.0627885a.js"><link rel="prefetch" href="/assets/js/19.110980f3.js"><link rel="prefetch" href="/assets/js/2.858e80da.js"><link rel="prefetch" href="/assets/js/20.fada5d94.js"><link rel="prefetch" href="/assets/js/21.fef9831b.js"><link rel="prefetch" href="/assets/js/22.312e3a38.js"><link rel="prefetch" href="/assets/js/23.33f46c53.js"><link rel="prefetch" href="/assets/js/24.00a66de9.js"><link rel="prefetch" href="/assets/js/25.2f188985.js"><link rel="prefetch" href="/assets/js/26.68654ac5.js"><link rel="prefetch" href="/assets/js/27.6cab9932.js"><link rel="prefetch" href="/assets/js/28.754b96e8.js"><link rel="prefetch" href="/assets/js/29.d1ed41d5.js"><link rel="prefetch" href="/assets/js/3.53ecd128.js"><link rel="prefetch" href="/assets/js/30.056a1a2e.js"><link rel="prefetch" href="/assets/js/31.274d0f03.js"><link rel="prefetch" href="/assets/js/32.d1ec2cf6.js"><link rel="prefetch" href="/assets/js/33.80d80fee.js"><link rel="prefetch" href="/assets/js/34.e1287e62.js"><link rel="prefetch" href="/assets/js/35.047e41da.js"><link rel="prefetch" href="/assets/js/36.dc87e012.js"><link rel="prefetch" href="/assets/js/37.9be237bc.js"><link rel="prefetch" href="/assets/js/38.a2ed656e.js"><link rel="prefetch" href="/assets/js/39.c6893003.js"><link rel="prefetch" href="/assets/js/4.ba718c7b.js"><link rel="prefetch" href="/assets/js/40.7fc8dd0c.js"><link rel="prefetch" href="/assets/js/41.95871ed4.js"><link rel="prefetch" href="/assets/js/42.2252d8af.js"><link rel="prefetch" href="/assets/js/43.081ffb45.js"><link rel="prefetch" href="/assets/js/44.a6b3c3cf.js"><link rel="prefetch" href="/assets/js/45.a3ce1167.js"><link rel="prefetch" href="/assets/js/46.befd8516.js"><link rel="prefetch" href="/assets/js/47.d0e55fa3.js"><link rel="prefetch" href="/assets/js/48.170cc5e4.js"><link rel="prefetch" href="/assets/js/49.dd11397f.js"><link rel="prefetch" href="/assets/js/5.4ebbb385.js"><link rel="prefetch" href="/assets/js/50.37023d3b.js"><link rel="prefetch" href="/assets/js/51.2abe7a3f.js"><link rel="prefetch" href="/assets/js/52.9860b2ac.js"><link rel="prefetch" href="/assets/js/53.ca23aed2.js"><link rel="prefetch" href="/assets/js/54.f172bf59.js"><link rel="prefetch" href="/assets/js/55.1b9517bc.js"><link rel="prefetch" href="/assets/js/57.0c5040c8.js"><link rel="prefetch" href="/assets/js/58.800fcd7b.js"><link rel="prefetch" href="/assets/js/59.5c9ae199.js"><link rel="prefetch" href="/assets/js/6.0bff5906.js"><link rel="prefetch" href="/assets/js/60.244e06d7.js"><link rel="prefetch" href="/assets/js/61.4989f930.js"><link rel="prefetch" href="/assets/js/62.0467583d.js"><link rel="prefetch" href="/assets/js/63.aea99875.js"><link rel="prefetch" href="/assets/js/64.1c08761a.js"><link rel="prefetch" href="/assets/js/65.93b72363.js"><link rel="prefetch" href="/assets/js/66.b57e2bb9.js"><link rel="prefetch" href="/assets/js/67.d6ca691a.js"><link rel="prefetch" href="/assets/js/68.18ac82fd.js"><link rel="prefetch" href="/assets/js/69.56cdd1c7.js"><link rel="prefetch" href="/assets/js/7.38fc841b.js"><link rel="prefetch" href="/assets/js/70.51c8d23a.js"><link rel="prefetch" href="/assets/js/71.de32e86c.js"><link rel="prefetch" href="/assets/js/72.03a9f5e4.js"><link rel="prefetch" href="/assets/js/73.e30bca5a.js"><link rel="prefetch" href="/assets/js/74.daa81746.js"><link rel="prefetch" href="/assets/js/75.b3683b54.js"><link rel="prefetch" href="/assets/js/76.43d2e38b.js"><link rel="prefetch" href="/assets/js/77.f3af5f07.js"><link rel="prefetch" href="/assets/js/78.8340d104.js"><link rel="prefetch" href="/assets/js/79.24cdce5c.js"><link rel="prefetch" href="/assets/js/8.f1e98a93.js"><link rel="prefetch" href="/assets/js/80.2ad1db1b.js"><link rel="prefetch" href="/assets/js/81.f1725f8c.js"><link rel="prefetch" href="/assets/js/82.c920e30f.js"><link rel="prefetch" href="/assets/js/83.e76f0172.js"><link rel="prefetch" href="/assets/js/84.eeb2593a.js"><link rel="prefetch" href="/assets/js/85.e613049c.js"><link rel="prefetch" href="/assets/js/86.b67437ac.js"><link rel="prefetch" href="/assets/js/87.40536e04.js"><link rel="prefetch" href="/assets/js/88.43da89fb.js"><link rel="prefetch" href="/assets/js/89.31670b27.js"><link rel="prefetch" href="/assets/js/9.76534e6a.js"><link rel="prefetch" href="/assets/js/90.356e80c4.js"><link rel="prefetch" href="/assets/js/91.efbe9da4.js"><link rel="prefetch" href="/assets/js/92.89a08c16.js"><link rel="prefetch" href="/assets/js/93.7bb24f82.js"><link rel="prefetch" href="/assets/js/94.6a11b890.js"><link rel="prefetch" href="/assets/js/95.5e6fe5c2.js"><link rel="prefetch" href="/assets/js/96.9a9179a7.js"><link rel="prefetch" href="/assets/js/97.622a7ef9.js"><link rel="prefetch" href="/assets/js/98.296286f0.js"><link rel="prefetch" href="/assets/js/99.caab6c7d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8eb0d87d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HACV</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/02.DataStructureAndAlgorithm/" class="nav-link">🐾数据结构和算法</a></div><div class="nav-item"><a href="/03.OS/" class="nav-link router-link-active">💻操作系统</a></div><div class="nav-item"><a href="/04.Net/" class="nav-link">☁️网络</a></div><div class="nav-item"><a href="/05.SE/" class="nav-link">☕️软件工程</a></div><div class="nav-item"><a href="/06.SQL/" class="nav-link">💾数据库</a></div><div class="nav-item"><a href="/07.InternalSkill/" class="nav-link">🐉计算机内功</a></div><div class="nav-item"><a href="/08.Tools/" class="nav-link">🔧Tools</a></div><div class="nav-item"><a href="/09.Language/" class="nav-link">⚛️C/C++</a></div><div class="nav-item"><a href="https://github.com/HACV" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/02.DataStructureAndAlgorithm/" class="nav-link">🐾数据结构和算法</a></div><div class="nav-item"><a href="/03.OS/" class="nav-link router-link-active">💻操作系统</a></div><div class="nav-item"><a href="/04.Net/" class="nav-link">☁️网络</a></div><div class="nav-item"><a href="/05.SE/" class="nav-link">☕️软件工程</a></div><div class="nav-item"><a href="/06.SQL/" class="nav-link">💾数据库</a></div><div class="nav-item"><a href="/07.InternalSkill/" class="nav-link">🐉计算机内功</a></div><div class="nav-item"><a href="/08.Tools/" class="nav-link">🔧Tools</a></div><div class="nav-item"><a href="/09.Language/" class="nav-link">⚛️C/C++</a></div><div class="nav-item"><a href="https://github.com/HACV" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>线程同步</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#cover-falsepassword" class="sidebar-link">cover: false
password:</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#内容" class="sidebar-link">内容</a></li></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#进程间同步的几种方法" class="sidebar-link">进程间同步的几种方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#哲学家吃饭问题：" class="sidebar-link">哲学家吃饭问题：</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#一、同步的概念" class="sidebar-link">一、同步的概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#二、互斥量mutex（互斥锁）" class="sidebar-link">二、互斥量mutex（互斥锁）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_1）pthread-mutex-init函数" class="sidebar-link">1）pthreadmutexinit函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_2）pthread-mutex-destroy函数" class="sidebar-link">2）pthreadmutexdestroy函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_3）pthread-mutex-lock函数" class="sidebar-link">3）pthreadmutexlock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_4）pthread-mutex-trylock函数" class="sidebar-link">4）pthreadmutextrylock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_5）pthread-mutex-unlock函数" class="sidebar-link">5）pthreadmutexunlock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#以上所有函数，要用的数据类型" class="sidebar-link">以上所有函数，要用的数据类型</a></li></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#先置结论-死锁" class="sidebar-link">先置结论+死锁</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#三、读写锁" class="sidebar-link">三、读写锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#读写锁状态：" class="sidebar-link">读写锁状态：</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#读写锁特性：" class="sidebar-link">读写锁特性：</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_1）pthread-rwlock-init函数" class="sidebar-link">1）pthreadrwlockinit函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_2）pthread-rwlock-destroy函数" class="sidebar-link">2）pthreadrwlockdestroy函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_3）pthread-rwlock-rdlock函数" class="sidebar-link">3）pthreadrwlockrdlock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_4）pthread-rwlock-wrlock函数" class="sidebar-link">4）pthreadrwlockwrlock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_5）pthread-rwlock-tryrdlock函数" class="sidebar-link">5）pthreadrwlocktryrdlock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_6）pthread-rwlock-trywrlock函数" class="sidebar-link">6）pthreadrwlocktrywrlock函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_7）pthread-rwlock-unlock函数" class="sidebar-link">7）pthreadrwlockunlock函数</a></li></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#四、条件变量（条件变量本身不是锁！）" class="sidebar-link">四、条件变量（条件变量本身不是锁！）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_1）pthread-cond-init函数" class="sidebar-link">1）pthreadcondinit函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_2）pthread-cond-destroy函数" class="sidebar-link">2）pthreadconddestroy函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_3）pthread-cond-wait函数（难点）" class="sidebar-link">3）pthreadcondwait函数（难点）</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_4）pthread-cond-timedwait函数" class="sidebar-link">4）pthreadcondtimedwait函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_5）pthread-cond-signal函数" class="sidebar-link">5）pthreadcondsignal函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_6）pthread-cond-broadcast函数" class="sidebar-link">6）pthreadcondbroadcast函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#线程同步—“生产者消费者”条件变量模型" class="sidebar-link">线程同步—“生产者消费者”条件变量模型</a></li></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#条件变量的优点：（为什么我们要引入这么多种锁的机制？？）" class="sidebar-link">条件变量的优点：（为什么我们要引入这么多种锁的机制？？）</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#五、信号量" class="sidebar-link">五、信号量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_1）sem-init函数" class="sidebar-link">1）sem_init函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_2）sem-destroy函数" class="sidebar-link">2）sem_destroy函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_3）sem-wait函数（相当于加锁，表示-）" class="sidebar-link">3）sem_wait函数（相当于加锁，表示--）</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_4）sem-trywait函数" class="sidebar-link">4）sem_trywait函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_5）sem-timedwait函数" class="sidebar-link">5）sem_timedwait函数</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_6）sem-post函数（相当于解锁，表示-）" class="sidebar-link">6）sem_post函数（相当于解锁，表示++）</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#“生产者消费者”-信号量（注意，比较条件变量下的模型）" class="sidebar-link">“生产者消费者”-信号量（注意，比较条件变量下的模型）</a></li></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#六、进程间同步" class="sidebar-link">六、进程间同步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#互斥量" class="sidebar-link">互斥量</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#文件锁（借助fcntl函数来实现锁机制）" class="sidebar-link">文件锁（借助fcntl函数来实现锁机制）</a></li></ul></li><li><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#哲学家用餐模型" class="sidebar-link">哲学家用餐模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_1）多线程版" class="sidebar-link">1）多线程版</a></li><li class="sidebar-sub-header"><a href="/03.OS/OSBasic/2020-07-22-Linux-System-Multithreading.html#_2）多进程版" class="sidebar-link">2）多进程版</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><hr> <p>title:  Linux系统——线程同步+进程同步
date: 2020-07-22 09:00:00
categories:</p> <ul><li>操作系统
tags:</li> <li>Linux</li></ul> <p>img: /photos/2020.6.03_15/2020_06_01_cover.jpg
top: false
summary: linux下锁机制
mathjax: true</p> <h2 id="cover-falsepassword"><a href="#cover-falsepassword" class="header-anchor">#</a> cover: false
password:</h2> <h1 id="线程同步"><a href="#线程同步" class="header-anchor">#</a> 线程同步</h1> <p>主控线程
子线程</p> <h3 id="内容"><a href="#内容" class="header-anchor">#</a> 内容</h3> <p>主要内容，线程同步。</p> <p>======
本章讲到的和<strong>线程</strong>相关的锁有4种。
1）互斥量(互斥锁)
2）读写锁
3）条件变量（线程当中一种常见的锁机制）
4）信号量：互斥量升级版
就是上面这4种</p> <blockquote><ul><li>同步概念：（区分，生活和编程中的同步的区别）
同步
线程同步</li></ul></blockquote> <blockquote><ul><li>1）互斥量(互斥锁):
一系列函数：都是以pthread_mutex开头,重点，如何应用这些函数对一个变量进行加锁访问。
pthread_mutex_init
_destroy
_lock
_unlock</li></ul></blockquote> <blockquote><ul><li>2)读写锁：
一系列函数都是以pthread_rwlock_开头的
pthread_rwlock_</li></ul></blockquote> <blockquote><ul><li>3)条件变量：
一系列函数为pthread_cond_开头的
pthread_cond_xxxx
pthread_cond_wait();函数（这是一个学习这部分的重点，而且这个函数也是条件变量的难点）
绝对时间：   1970/1/1  00:00:00  --- unix 计时元年。
time_t cur = time(NULL);
strcut timespec t;
t.tv_sec = cur + 10;
pthread_cond_timedwait(&amp;cond, &amp;mutex, &amp;t);</li></ul></blockquote> <blockquote><ul><li>4)信号量：是互斥量升级版
一系列函数为sem_开头的
发现，少了那个pthread关键字，所以说，信号量不单单能用于线程间同步，还能用于进程间同步！
sem_</li></ul></blockquote> <h2 id="进程间同步的几种方法"><a href="#进程间同步的几种方法" class="header-anchor">#</a> 进程间同步的几种方法</h2> <p>1）信号量（Semaphore）
一系列函数为sem_开头的
2）文件锁
3）互斥量和信号量联合的一种方式</p> <h2 id="哲学家吃饭问题："><a href="#哲学家吃饭问题：" class="header-anchor">#</a> 哲学家吃饭问题：</h2> <p>1）线程版本
2）进程版本</p> <h2 id="一、同步的概念"><a href="#一、同步的概念" class="header-anchor">#</a> 一、同步的概念</h2> <p>所谓同步，即同时起步，协调一致。不同的对象，对“同步”的理解方式略有不同。
如，<strong>硬件</strong>上的设备，设备同步，是指在两个设备之间规定一个共同的时间参考；
<strong>数据库同步</strong>，是指让两个或多个数据库内容保持一致，或者按需要部分保持一致；
<strong>文件同步</strong>，是指让两个或多个文件夹里的文件保持一致。等等.</p> <blockquote><ul><li>而，<strong>编程中、通信中</strong>所说的同步与生活中大家印象中的同步概念略有差异。
“同”字应是指<strong>协同、协助、互相配合</strong>。
主旨在协同步调，按预定的先后次序运行。</li></ul></blockquote> <p>各个行业，对同步的理解方式是不一样的！！！</p> <p>线程同步，官方说法
线程同步，指一个线程发出某一功能调用时，在没有得到结果之前，该调用不返回。同时其它线程为<strong>保证数据一致性</strong>，不能调用该功能。</p> <p>不同的对象，对同一个数据同时进行操作，这个数据，我们称为共享数据或者叫共享资源。</p> <p>注意：
a,b,c都是一个进程中的线程
假设a和b都拿锁去访问，而c不拿锁就去直接访问
能不能成功？？
可以的，因为他们都共享那个变量
（但是这样会导致出现错误）
这把锁不具有强制性！！！</p> <p>在Linux，用户层面上编程所用到的所有的锁，我们都把他称之为<strong>建议锁</strong>。
所以这个，指的是Linux内核建议你在访问共享数据的时候，加一把锁再访问。是否具有强制性？？
不具有！！！
<font size="5" style="background:yellow;">因此访问共享数据的所有线程，要想保证数据不出现混乱。
都应该先加锁后访问才行！！！</font></p> <p>如果像前面那样的，直接访问，会导致数据尴尬的。</p> <p>描述的锁，如何在应用程序中表示出来呢？就需要一个变量表示出来。这个变量叫做互斥量（或者互斥锁）</p> <h2 id="二、互斥量mutex（互斥锁）"><a href="#二、互斥量mutex（互斥锁）" class="header-anchor">#</a> 二、互斥量mutex（互斥锁）</h2> <p>Linux中提供一把互斥锁mutex（也称之为互斥量）。
每个线程在对资源操作前都尝试先加锁，成功加锁才能操作，操作结束解锁。
资源还是共享的，线程间也还是竞争的，
但通过“锁”就将资源的访问变成<strong>互斥</strong>操作，而后与时间有关的错误也不会再产生了。</p> <p>主要应用函数：</p> <h3 id="_1）pthread-mutex-init函数"><a href="#_1）pthread-mutex-init函数" class="header-anchor">#</a> 1）pthread_mutex_init函数</h3> <p>将互斥量初始化</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_mutexattr_t</span> <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意到上面有个关键字：
<font size="5" style="background:yellow;"><strong>restrict关键字</strong></font>：只用于限制指针，告诉编译器，所有修改该指针指向内存中内容的操作，<strong>只能通过本指针完成</strong>。不能通过除本指针以外的其他变量或指针修改</p> <h3 id="_2）pthread-mutex-destroy函数"><a href="#_2）pthread-mutex-destroy函数" class="header-anchor">#</a> 2）pthread_mutex_destroy函数</h3> <p>互斥量销毁</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>	<span class="token keyword">int</span> <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_3）pthread-mutex-lock函数"><a href="#_3）pthread-mutex-lock函数" class="header-anchor">#</a> 3）pthread_mutex_lock函数</h3> <p>互斥量加锁</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_4）pthread-mutex-trylock函数"><a href="#_4）pthread-mutex-trylock函数" class="header-anchor">#</a> 4）pthread_mutex_trylock函数</h3> <p>这个是，尝试加锁，如果成功则锁上，否则直接返回（不会阻塞等待）
返回的这些，我可以干其他事情，我可以过个几秒再来一次加锁
显然，要想用这个，我们需要，轮询（周期性的尝试加锁）</p> <p>而互斥量加锁，却要阻塞等待</p> <h3 id="_5）pthread-mutex-unlock函数"><a href="#_5）pthread-mutex-unlock函数" class="header-anchor">#</a> 5）pthread_mutex_unlock函数</h3> <p>互斥量解锁</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上5个函数的返回值都是：成功返回0， 失败返回错误号。</p> <h3 id="以上所有函数，要用的数据类型"><a href="#以上所有函数，要用的数据类型" class="header-anchor">#</a> 以上所有函数，要用的数据类型</h3> <p><code>pthread_mutex_t</code> 类型，其本质是一个结构体。
为简化理解，应用时可忽略其实现细节，简单当成整数看待。
可以简单看待，初始化完成后，取值为1，加锁成功，值由1--变成0
解锁成功，这个值由0++变成1
（两种取值）</p> <p>pthread_mutex_t mutex;
变量mutex只有两种取值1、0。</p> <h2 id="先置结论-死锁"><a href="#先置结论-死锁" class="header-anchor">#</a> 先置结论+死锁</h2> <p>在访问共享资源前加锁，访问结束后<strong>立即解锁</strong>。<strong>锁的“粒度”应越小越好</strong>。</p> <p>死锁：
我们的线程在使用互斥量，或者其他同步机制过程当中，出现的一种现象。而不是锁的一种机制。
（我记得，我学的操作系统中，线程和进程都有死锁现象把。。）</p> <p>比如下面两种死锁</p> <ol><li>线程试图对同一个互斥量A加锁两次。（解决方案：加锁完，立即解锁）</li> <li>线程1拥有A锁，请求获得B锁；线程2拥有B锁，请求获得A锁（解决方案：trylock尝试加锁，就不会阻塞了）（当不能获取所有的锁的时候，放弃已经占有的所有的锁）</li></ol> <h2 id="三、读写锁"><a href="#三、读写锁" class="header-anchor">#</a> 三、读写锁</h2> <p>读写锁（相较于互斥锁来说，性能稍微高一些）</p> <p><font size="5" style="background:yellow;">注意：读写锁，锁只有一把，不是两把</font>
与互斥量类似，但读写锁允许<strong>更高的并行性</strong>。
其特性为：写独占，读共享</p> <p>这把锁，既可以用“读”的方式对变量加锁，而且还能以“写”的方式对变量加锁</p> <h3 id="读写锁状态："><a href="#读写锁状态：" class="header-anchor">#</a> 读写锁状态：</h3> <p>一把读写锁具备三种状态：</p> <ol><li>读模式下加锁状态 (读锁)</li> <li>写模式下加锁状态 (写锁)</li> <li>不加锁状态</li></ol> <p>掌握读写锁，记住下面就好了：
写锁优先级高，写独占、读共享</p> <h3 id="读写锁特性："><a href="#读写锁特性：" class="header-anchor">#</a> 读写锁特性：</h3> <p>1.读写锁是“写模式加锁”时， 解锁前，所有对该锁加锁的线程都会被阻塞。
2.读写锁是“读模式加锁”时， 如果线程以读模式对其加锁会成功；如果线程以写模式加锁会阻塞。
3.读写锁是“读模式加锁”时， 既有试图以写模式加锁的线程，也有试图以读模式加锁的线程。那么读写锁会阻塞随后的读模式锁请求。优先满足写模式锁。读锁、写锁并行阻塞，<strong>写锁优先级高</strong></p> <p><font size="5" style="background:yellow;">读写锁也叫<strong>共享-独占锁</strong>。</font>
当读写锁以读模式锁住时，它是以共享模式锁住的；当它以写模式锁住时，它是以独占模式锁住的。<strong>写独占、读共享。</strong>
读写锁非常适合于对数据结构读的次数远大于写的情况。</p> <h3 id="_1）pthread-rwlock-init函数"><a href="#_1）pthread-rwlock-init函数" class="header-anchor">#</a> 1）pthread_rwlock_init函数</h3> <p>初始化一把读写锁</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>	<span class="token keyword">int</span> <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span><span class="token class-name">pthread_rwlock_t</span> <span class="token operator">*</span>restrict rwlock<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_rwlockattr_t</span> <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参2：attr表读写锁属性，通常使用默认属性，传NULL即可。</p> <h3 id="_2）pthread-rwlock-destroy函数"><a href="#_2）pthread-rwlock-destroy函数" class="header-anchor">#</a> 2）pthread_rwlock_destroy函数</h3> <h3 id="_3）pthread-rwlock-rdlock函数"><a href="#_3）pthread-rwlock-rdlock函数" class="header-anchor">#</a> 3）pthread_rwlock_rdlock函数</h3> <h3 id="_4）pthread-rwlock-wrlock函数"><a href="#_4）pthread-rwlock-wrlock函数" class="header-anchor">#</a> 4）pthread_rwlock_wrlock函数</h3> <h3 id="_5）pthread-rwlock-tryrdlock函数"><a href="#_5）pthread-rwlock-tryrdlock函数" class="header-anchor">#</a> 5）pthread_rwlock_tryrdlock函数</h3> <h3 id="_6）pthread-rwlock-trywrlock函数"><a href="#_6）pthread-rwlock-trywrlock函数" class="header-anchor">#</a> 6）pthread_rwlock_trywrlock函数</h3> <h3 id="_7）pthread-rwlock-unlock函数"><a href="#_7）pthread-rwlock-unlock函数" class="header-anchor">#</a> 7）pthread_rwlock_unlock函数</h3> <p>以上7 个函数的返回值都是：成功返回0， 失败直接返回错误号。</p> <p>pthread_rwlock_t类型	用于定义一个读写锁变量。
pthread_rwlock_t rwlock;</p> <p>看如下示例，同时有多个线程对同一全局数据读、写操作。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">int</span> counter<span class="token punctuation">;</span>
<span class="token class-name">pthread_rwlock_t</span> rwlock<span class="token punctuation">;</span>

<span class="token comment">/* 3个线程不定时写同一全局资源，5个线程不定时读同一全局资源 */</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">th_write</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> t<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_rwlock_wrlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t <span class="token operator">=</span> counter<span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;=======write %d: %lu: counter=%d ++counter=%d\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token operator">++</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">th_read</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_rwlock_rdlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;----------------------------read %d: %lu: %d\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_rwlock_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">pthread_rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> th_write<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> th_read<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_rwlock_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rwlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="四、条件变量（条件变量本身不是锁！）"><a href="#四、条件变量（条件变量本身不是锁！）" class="header-anchor">#</a> 四、条件变量（条件变量本身不是锁！）</h2> <p>条件变量：（一定要满足某个条件，才能咋咋咋样）
条件变量本身不是锁！但它也可以造成线程阻塞。
<strong>通常与互斥锁配合使用</strong>。给多线程提供一个会合的场所。</p> <p>会合的场所：指的共享数据</p> <p>主要应用函数：</p> <h3 id="_1）pthread-cond-init函数"><a href="#_1）pthread-cond-init函数" class="header-anchor">#</a> 1）pthread_cond_init函数</h3> <h3 id="_2）pthread-cond-destroy函数"><a href="#_2）pthread-cond-destroy函数" class="header-anchor">#</a> 2）pthread_cond_destroy函数</h3> <h3 id="_3）pthread-cond-wait函数（难点）"><a href="#_3）pthread-cond-wait函数（难点）" class="header-anchor">#</a> 3）pthread_cond_wait函数（难点）</h3> <p>它可以干3件事情
阻塞等待一个条件变量</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token class-name">pthread_cond_t</span> <span class="token operator">*</span>restrict cond<span class="token punctuation">,</span> <span class="token class-name">pthread_mutex_t</span> <span class="token operator">*</span>restrict mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>函数作用：
1.阻塞等待条件变量cond（参1）满足
2.释放已掌握的互斥锁（解锁互斥量）相当于pthread_mutex_unlock(&amp;mutex);
** 1.2.两步为一个原子操作。**
3.<strong>当被唤醒</strong>，pthread_cond_wait函数返回时，解除阻塞并重新申请获取互斥锁pthread_mutex_lock(&amp;mutex);</p> <p>谁来唤醒？？
<code>pthread_cond_signal</code>函数
唤醒至少一个阻塞在条件变量上的线程</p> <p><code>pthread_cond_broadcast</code>函数（broadcast，广播，计算机网络，网络编程中也讲这个）
唤醒全部阻塞在条件变量上的线程</p> <h3 id="_4）pthread-cond-timedwait函数"><a href="#_4）pthread-cond-timedwait函数" class="header-anchor">#</a> 4）pthread_cond_timedwait函数</h3> <h3 id="_5）pthread-cond-signal函数"><a href="#_5）pthread-cond-signal函数" class="header-anchor">#</a> 5）pthread_cond_signal函数</h3> <h3 id="_6）pthread-cond-broadcast函数"><a href="#_6）pthread-cond-broadcast函数" class="header-anchor">#</a> 6）pthread_cond_broadcast函数</h3> <p>以上6 个函数的返回值都是：成功返回0， 失败直接返回错误号。</p> <p>pthread_cond_t类型	用于定义条件变量
pthread_cond_t cond;</p> <p>应用场景呢？？</p> <h3 id="线程同步—“生产者消费者”条件变量模型"><a href="#线程同步—“生产者消费者”条件变量模型" class="header-anchor">#</a> 线程同步—“生产者消费者”条件变量模型</h3> <p>线程同步中最最知名的一个模型。
只要提到，几乎都会提到这个模型。</p> <blockquote><ul><li>假定有两个线程，一个模拟生产者行为，一个模拟消费者行为。
两个线程同时操作一个共享资源（一般称之为<strong>汇聚</strong>），生产向其中添加产品，消费者从中消费掉产品。</li></ul></blockquote> <p>显然，这个的条件变量就是：已经生产了产品</p> <p>看如下示例，使用条件变量模拟生产者、消费者问题：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token keyword">int</span> num<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>head<span class="token punctuation">;</span>

<span class="token class-name">pthread_cond_t</span> has_product <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>
<span class="token class-name">pthread_mutex_t</span> lock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">consumer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>mp<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>head <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment">//头指针为空,说明没有节点    可以为if吗</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>has_product<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mp <span class="token operator">=</span> head<span class="token punctuation">;</span>      
        head <span class="token operator">=</span> mp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>    			<span class="token comment">//模拟消费掉一个产品</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;-Consume ---%d\n&quot;</span><span class="token punctuation">,</span> mp<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">msg</span> <span class="token operator">*</span>mp<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mp <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">msg</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mp<span class="token operator">-&gt;</span>num <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment">//模拟生产一个产品</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;-Produce ---%d\n&quot;</span><span class="token punctuation">,</span> mp<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mp<span class="token operator">-&gt;</span>next <span class="token operator">=</span> head<span class="token punctuation">;</span>
        head <span class="token operator">=</span> mp<span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>has_product<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将等待在该条件变量上的一个线程唤醒</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">pthread_t</span> pid<span class="token punctuation">,</span> cid<span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> producer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> consumer<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>cid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>互斥量在使用的时候，要注意把握一下，锁的**”粒度“**（或者叫做锁的“临界区”）
建议，锁的粒度（临界区）越小越好。
<font size="5" style="background:yellow;">此处和<code>《程序员的自我修养-链接，装载与库》</code>说的临界区咋不一样。。</font></p> <p>读写锁使用的场景：
如果对数据读的次数远远大于写的时候
但是，如果所有操作都是写的话。
用“读写锁”和“互斥量”没有区别。
但是，如果，读比写多，显然读写锁更好。</p> <h2 id="条件变量的优点：（为什么我们要引入这么多种锁的机制？？）"><a href="#条件变量的优点：（为什么我们要引入这么多种锁的机制？？）" class="header-anchor">#</a> 条件变量的优点：（为什么我们要引入这么多种锁的机制？？）</h2> <p><font size="3" style="background:yellow;">为什么我们要引入这么多种锁的机制？？最开始的互斥锁，不是已经可以完成保护数据的目的了吗？为什么还要引入读写锁呢？因为在读比写更多的场景，读写锁的效率比互斥锁高。那又为什么要引入条件变量呢？<strong>因为条件变量相对于我们的互斥量而言，它也可以减少一些不必要的竞争啊</strong>
原因如下：
相较于mutex而言，条件变量可以减少竞争。</font></p> <p>如直接使用mutex，除了生产者、消费者之间要竞争互斥量以外，消费者之间也需要竞争互斥量，但<strong>如果汇聚（链表）中没有数据，消费者之间竞争互斥锁是无意义的</strong>。有了条件变量机制以后，只有生产者完成生产，才会引起消费者之间的竞争。提高了程序效率。</p> <h2 id="五、信号量"><a href="#五、信号量" class="header-anchor">#</a> 五、信号量</h2> <p>注意，信号和信号量没有关系。就像java和JavaScript没关系一样。</p> <p><font style="background:yellow;">信号量的初值，决定了占用信号量的线程的个数。</font></p> <p>信号量对于<strong>线程同步</strong>来说，可以把它理解成一个进化版的互斥锁。
比如，互斥量初始化之后是1，强调这个是为了给信号量做铺垫。
而我们的信号量初始化之后是N。</p> <p>原来，互斥锁，只能供1个线程同时使用
现在，信号量，可以指定成N个线程同时过来，获取这把锁。（<strong>提升了，共同访问共享资源的线程数量</strong>）
好比
买了量车，小轿车可以载4个人（带4个线程）
买了两人座的，那么可以载1人（带一个线程）</p> <p>进化版的互斥锁（1 --&gt; N）</p> <blockquote><ul><li>互斥锁的粒度比较大，如果我们希望在<strong>多个线程</strong>间对<strong>某一对象</strong>的<strong>部分数据</strong>进行共享，使用互斥锁是没有办法实现的，只能将整个数据对象锁住。这样虽然达到了多线程操作共享数据时保证数据正确性的目的，却无形中导致线程的并发性下降。线程从并行执行，变成了串行执行。与直接使用单进程无异。</li> <li><strong>信号量，是相对折中的一种处理方式，既能保证同步，数据不混乱，又能提高线程并发。</strong></li></ul></blockquote> <p>主要应用函数：</p> <h3 id="_1）sem-init函数"><a href="#_1）sem-init函数" class="header-anchor">#</a> 1）sem_init函数</h3> <p>初始化一个信号量</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">int</span> pshared<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参1：sem信号量	
参2：pshared取0用于线程间；取非0（一般为1）用于进程间
参3：value指定信号量初值</p> <h3 id="_2）sem-destroy函数"><a href="#_2）sem-destroy函数" class="header-anchor">#</a> 2）sem_destroy函数</h3> <h3 id="_3）sem-wait函数（相当于加锁，表示-）"><a href="#_3）sem-wait函数（相当于加锁，表示-）" class="header-anchor">#</a> 3）sem_wait函数（相当于加锁，表示--）</h3> <h3 id="_4）sem-trywait函数"><a href="#_4）sem-trywait函数" class="header-anchor">#</a> 4）sem_trywait函数</h3> <h3 id="_5）sem-timedwait函数"><a href="#_5）sem-timedwait函数" class="header-anchor">#</a> 5）sem_timedwait函数</h3> <p>限时尝试对信号量加锁</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">sem_timedwait</span><span class="token punctuation">(</span><span class="token class-name">sem_t</span> <span class="token operator">*</span>sem<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>abs_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参2：abs_timeout采用的是绝对时间.</p> <h3 id="_6）sem-post函数（相当于解锁，表示-）"><a href="#_6）sem-post函数（相当于解锁，表示-）" class="header-anchor">#</a> 6）sem_post函数（相当于解锁，表示++）</h3> <p>以上6 个函数的返回值都是：成功返回0， 失败返回-1，同时设置errno。(注意，它们没有pthread前缀)
sem_t类型，本质仍是结构体。但应用期间可简单看作为整数，忽略实现细节（类似于使用文件描述符）。
sem_t sem; 规定信号量<code>sem不能&lt;0</code>
头文件<code>&lt;semaphore.h&gt;</code></p> <h3 id="“生产者消费者”-信号量（注意，比较条件变量下的模型）"><a href="#“生产者消费者”-信号量（注意，比较条件变量下的模型）" class="header-anchor">#</a> “生产者消费者”-信号量（注意，比较条件变量下的模型）</h3> <p>公共区域，用的“环形队列”</p> <h2 id="六、进程间同步"><a href="#六、进程间同步" class="header-anchor">#</a> 六、进程间同步</h2> <p>我们详细讲下面2种锁</p> <p>1）信号量
2）互斥量也可以
3）文件锁</p> <h3 id="互斥量"><a href="#互斥量" class="header-anchor">#</a> 互斥量</h3> <p>进程间也可以使用互斥锁，来达到同步的目的。但应在pthread_mutex_init初始化之前，修改其<strong>属性</strong>为进程间共享。mutex的属性修改函数主要有以下几个。</p> <p>主要应用函数：</p> <h4 id="_1）pthread-mutexattr-t-mattr-类型："><a href="#_1）pthread-mutexattr-t-mattr-类型：" class="header-anchor">#</a> 1）pthread_mutexattr_t mattr 类型：</h4> <p>用于定义mutex锁的【属性】</p> <h4 id="_2）pthread-mutexattr-init函数："><a href="#_2）pthread-mutexattr-init函数：" class="header-anchor">#</a> 2）pthread_mutexattr_init函数：</h4> <p>初始化一个mutex属性对象</p> <h4 id="_3）int-pthread-mutexattr-init-pthread-mutexattr-t-attr"><a href="#_3）int-pthread-mutexattr-init-pthread-mutexattr-t-attr" class="header-anchor">#</a> 3）int pthread_mutexattr_init(pthread_mutexattr_t *attr);</h4> <pre><code>pthread_mutexattr_destroy函数：		
销毁mutex属性对象 (而非销毁锁)
</code></pre> <h4 id="_4）int-pthread-mutexattr-destroy-pthread-mutexattr-t-attr"><a href="#_4）int-pthread-mutexattr-destroy-pthread-mutexattr-t-attr" class="header-anchor">#</a> 4）int pthread_mutexattr_destroy(pthread_mutexattr_t *attr);</h4> <h4 id="_5）pthread-mutexattr-setpshared函数：修改mutex属性。"><a href="#_5）pthread-mutexattr-setpshared函数：修改mutex属性。" class="header-anchor">#</a> 5）pthread_mutexattr_setpshared函数：	修改mutex属性。</h4> <h4 id="_6）int-pthread-mutexattr-setpshared-pthread-mutexattr-t-attr-int-pshared"><a href="#_6）int-pthread-mutexattr-setpshared-pthread-mutexattr-t-attr-int-pshared" class="header-anchor">#</a> 6）int pthread_mutexattr_setpshared(pthread_mutexattr_t *attr, int pshared);</h4> <p>参2：pshared取值：
线程锁：PTHREAD_PROCESS_PRIVATE (mutex的默认属性即为线程锁，进程间私有)
进程锁：PTHREAD_PROCESS_SHARED</p> <p>进程间使用mutex来实现同步：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/mman.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">mt</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> num<span class="token punctuation">;</span>
    <span class="token class-name">pthread_mutex_t</span> mutex<span class="token punctuation">;</span>
    <span class="token class-name">pthread_mutexattr_t</span> mutexattr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">mt</span> <span class="token operator">*</span>mm<span class="token punctuation">;</span>
    <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;mt_test&quot;</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_RDWR<span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ftruncate</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>mm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mm <span class="token operator">=</span> <span class="token function">mmap</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>mm<span class="token punctuation">)</span><span class="token punctuation">,</span> PROT_READ<span class="token operator">|</span>PROT_WRITE<span class="token punctuation">,</span> MAP_SHARED<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token string">&quot;mt_test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//mm = mmap(NULL, sizeof(*mm), PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANON, -1, 0);</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>mm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>mm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_mutexattr_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">//初始化mutex属性对象</span>
    <span class="token function">pthread_mutexattr_setpshared</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutexattr<span class="token punctuation">,</span> PTHREAD_PROCESS_SHARED<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//修改属性为进程间共享</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutex<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//初始化一把mutex琐</span>

    pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>mm<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span><span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;-child----num++   %d\n&quot;</span><span class="token punctuation">,</span> mm<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mm<span class="token operator">-&gt;</span>num <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;-parent---num+=2  %d\n&quot;</span><span class="token punctuation">,</span> mm<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pthread_mutexattr_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutexattr<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//销毁mutex属性对象</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mm<span class="token operator">-&gt;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">//销毁mutex</span>
    <span class="token function">munmap</span><span class="token punctuation">(</span>mm<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>mm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">//释放映射区</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>					
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="文件锁（借助fcntl函数来实现锁机制）"><a href="#文件锁（借助fcntl函数来实现锁机制）" class="header-anchor">#</a> 文件锁（借助fcntl函数来实现锁机制）</h3> <p>（记忆方法：file control）</p> <p>操作文件的进程没有获得锁时，可以打开，但无法执行read、write操作。
fcntl函数：获取、设置文件访问控制属性。</p> <p>我们以前用这个修改过，阻塞和非阻塞</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">fcntl</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参2：</p> <div class="language-txt line-numbers-mode"><pre class="language-text"><code>F_SETLK (struct flock *)	设置文件锁（trylock）
F_SETLKW (struct flock *) 设置文件锁（lock）W --&gt; wait
F_GETLK (struct flock *)	获取文件锁
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>【思考】：多线程中，可以使用文件锁吗？
多线程间共享文件描述符，而给文件加锁，是通过修改文件描述符所指向的文件结构体中的成员变量来实现的。因此，多线程中无法使用文件锁。</p> <h2 id="哲学家用餐模型"><a href="#哲学家用餐模型" class="header-anchor">#</a> 哲学家用餐模型</h2> <p>振荡：如果每个人都攥着自己左手的锁，尝试去拿右手锁，拿不到则将锁释放。过会儿五个人又同时再攥着左手锁尝试拿右手锁，依然拿不到。如此往复形成另外一种极端死锁的现象——振荡。</p> <p>如何避免这种“震荡”的死锁？
避免振荡现象：只需5个人中，任意一个人，拿锁的方向与其他人相逆即可(如：E，原来：左：4，右：0	现在：左：0， 右：4)。</p> <p>（特立独行2333的哲学家）</p> <h3 id="_1）多线程版"><a href="#_1）多线程版" class="header-anchor">#</a> 1）多线程版</h3> <h3 id="_2）多进程版"><a href="#_2）多进程版" class="header-anchor">#</a> 2）多进程版</h3></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.497fe22e.js" defer></script><script src="/assets/js/56.80334add.js" defer></script>
  </body>
</html>
